# R package {#package}

_As part of assignment 8 from the [DSFB2 Workflows course](https://lesmaterialen.rstudio.hu.nl/workflows-reader/rpackages.html)._

----

For this assignment the previous assignments will be analysed to check for any repetitive code. This code will be turned into functions, combined into my first R package. 

----

## The Demo

The [Whole Game demo](https://r-pkgs.org/whole-game.html) made by Hadley Wickham was followed to start creating the R package. This demo was a complete guide through setting up the package, connecting it to Git and writing the first function. It went over useful packages like roxygen2 and testthat. A short summary of packages and functions was made based on what I learned in the demo for later use.

<details><summary><i>R package building cheatsheet</i></summary>
<b>Useful libraries:</b><br>
library(devtools)<br>
library(usethis)<br>
library(roxygen2)<br>
library(testthat)<br>

<b>How roxygen2 works:</b>
<ol><li>Put cursor in function</li>
<li>Code -> insert roxygen skeleton/li>>
<li>Fill in necessary details</li></ol>

<b>Important functions:</b><br>
create_package("~/path/to/package/packaganame")<br>
-- Creates package

use_git()<br>
-- Connects to git

use_r("filename")<br>
-- Opens/creates script in R/

load_all()<br>
-- Loads all functions without using globalenv

exists("function", where = globalenv(), inherits = FALSE)<br>
-- Checks if function exists in globalenv

check()<br>
-- Checks entire package for errors/warnings/notes

use_mit_license()<br>
-- Sets license to MIT

document()<br>
-- Creates/updates the manuals in man/ based on roxygen<br>
-- Updates the NAMESPACE file

install()<br>
-- Installs the package

use_testthat()<br>
-- Declares our intent to write tests<br>
-- Creates test directories

use_test("functionname")<br>
-- Opens/create a testfile

test()<br>
-- Performs all tests

use_package("packagename")<br>
-- Add a package to import in DESCRIPTION

rename_files("oldname", "newname")<br>
-- Rename files

use_readme_rmd()<br>
-- Writes README template<br>
-- Adds readme to the ignore file

build_readme()<br>
-- Updates the readme.md file based on the readme.rmd
</details>

----

## RMarkdown driven development

In the Workflows course the use of "Start with RMarkdown" was emphasized. This style of creating an R package does not start from zero like the demo suggested. It is based on a pre-written RMarkdown and the scripts that came with it. 

There are a lot of advantages to creating a complete all-in-one package when sharing a RMarkdown based analysis for others to reproduce. Usually, this sharing happens through an RMarkdown, some functions, the tidy version of the data, the steps used to get it tidy, the analysis itself and the used packages. These are multiple separate elements for someone to go over before they can reproduce the analysis. It can be made a lot more efficient by taking a few extra steps to create an R package from the RMarkdown. This way the elements are combined in one unit which is easily shared and can be used for multiple purposes and on different datasets.

----

## Package "portrobbo"

For this assignment we were asked to create a package which supports our portfolio. This will make the RMarkdowns more fluid and reduce duplicated code. It can also be used for later analysis.

### Picking a name

To find an available but still meaningful name I wanted to combine the word 'portfolio' with my partner's name. My partner happens to work on ships so the name portrobbo (combining the words 'portfolio', 'port' and his name) came to mind. After checking the availability I decided to use that as the name for my first R package. After setting up the project for the package and the [github repository](https://github.com/mirthhe/portrobbo) it was ready for it's first function. 

### An overview

The package currently contains the following functions:
<ul>
<li>uniq_val</li>
<li>save_csv_rds</li>
<li>graph_jitter</li>
<li>protein visualizations:<ul>
<li>protein_cartoon</li>
<li>protein_sphere</li>
<li>protein_stick</li>
<li>protein_visual</li></ul></ul>

The package also contains two data objects:

[COVID19](https://github.com/mirthhe/portrobbo/blob/main/data/covid19.rda), a dataframe containing COVID19 cases and deaths in multiple European countries. The data came from the [ECDC](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide). It was imported using [this code](https://github.com/mirthhe/portrobbo/blob/main/data-raw/covid19.R) and is used to show the functionality of uniq_val(), save_csv_rds() and graph_jitter().

[Kinesin](https://github.com/mirthhe/portrobbo/blob/main/data/kinesin.rda), an R object containing the PDBx file 3COB. The [data](https://github.com/mirthhe/portrobbo/blob/main/data-raw/3cob.pdb) came from the [RCSB PDB](https://www.rcsb.org/structure/3COB). It was imported using [this code](https://github.com/mirthhe/portrobbo/blob/main/data-raw/kinesin.R) and is used to show the functionality of the protein visualizing functions.

### uniq_val

The first function focuses on the data inspection. When working with a big dataset it can be used to check the amount of unique values within a column. For example, in chapter 7 we look at the dataset COVID19. The dataset has 28729 observations. Since there are multiple observations per country it is important to know how many countries are looked at. This is where uniq_val() comes in. The only input for the function is the column of which the amount of unique values should be checked. It's use can be seen in [chapter 7](Workflows_Portfolio_9.html) or in the code chunk below. 

```{r uniq_val check, eval=FALSE}
# The column with the names of the countries is countriesAndTerritories
uniq_val(covid19$countriesAndTerritories)
```

The 28729 observations are divided over 30 different countries. Good to know! There are other columns, also indicating a country or region. uniq_val() can also be used to check if those other columns show the same amount of unique values, by doing the following.

```{r uniq_val compare, eval=FALSE}
# Another column indicating the country is geoId
uniq_val(covid19$countriesAndTerritories) == uniq_val(covid19$geoId)
```

### save_csv_rds

After inspecting the data you might have made a few changes in the R object, like making it tidy or extracting data that is the most useful as shown in the following code. 

```{r data extraction}
# Let's say we only want the data of summer 2020 for the Germany and France
covid19_2020 <- covid19 %>% filter(countriesAndTerritories == 
                                     c("Germany", "France"), 
                                   year == 2020, month == c(6:8))
covid19_2020$dateRep <- as.Date(covid19_2020$dateRep, "%d/%m/%y")
```

It is important to save your changes for later reference. A good way to do that is by using the save_csv_rds() function. This saves your dataframe as both a .csv and .rds file and uses the dataframe and an outputname as inputs. It's use can be seen in [chapter 5](Workflows_Portfolio_7.html) or in the code chunk below.

```{r save_csv_rds, eval=FALSE}
# In this case we want the outputname to be the same as the dataframe name
save_csv_rds(covid19_2020, "covid19_2020")
```

### graph_jitter

With the data inspected, extracted and saved, graphs can be made. The ggplot2 package contains all the necessary functions to make a graph. It's functions have a lot of different input options for a lot of different graphs. This means the code for a simple graph can become quite long. This is where graph_jitter() comes in. The ggplot2 function position_jitter() uses multiple inputs to create a slight jitter to the datapoints. This is useful when data overlap makes the graph hard to read. The graph_jitter() function simplifies this function by only needing one input which will work for both the height and width of the jitter. It also sets the seed to keep jitter consistent throughout the analysis. In the following code chunk the use of graph_jitter() is shown.

```{r graph_jitter}
covid19_2020 %>% ggplot(aes(x = dateRep, y = deaths)) +
  geom_line(aes(group=countriesAndTerritories, color = countriesAndTerritories)) +
  geom_point(aes(color = countriesAndTerritories), position = graph_jitter(0.3)) +
  labs(title = "COVID19 in summer of 2020",
       x = "Date",
       y = "COVID19 related deaths") +
  theme_minimal()
```

_Figure 6.1 Scatterplot showing the COVID19 related deaths in summer of 2020 in Germany and France._

### Protein visualization functions

The last four functions use the [r3dmol](https://github.com/swsoyee/r3dmol) package to create 3D interactive visualizations of proteins. Each function shows a different style of visualization. They have been made to support the free assignment and their use  can be seen in [chapter 8](Workflows_Portfolio_Free.html#applying-in-r). 