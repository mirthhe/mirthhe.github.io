# SQL and relational data {#relational}

_As part of assignment 7 from the [DSFB2 Workflows course](https://lesmaterialen.rstudio.hu.nl/workflows-reader/relationaldb.html)._

----

So far the subjects have been about a couple different things, like R, BASH, HTML and CSS. Another important language to understand is SQL. With this assignment the focus is on learning the basics of SQL and applying it to relational data. To start, the dataframes will be created, using the files provided in the assignment, and tidied up.

```{r import and tidy data}
# Import flu data ----
flu_df <- read_csv("data-raw/relationaldata/flu_data.csv", skip=11) ## First 11 rows are metadata
# Make flu dataframe tidy ----
flu_df_tidy <- flu_df %>% pivot_longer(cols = c(2:ncol(flu_df)), 
                                       names_to = 'country', 
                                       values_to = 'cases') %>% na.omit()

# Import dengue data ----
dengue_df <- read_csv("data-raw/relationaldata/dengue_data.csv", skip=11) ## First 11 rows are metadata
# Make dengue data tidy ----
dengue_df_tidy <- dengue_df %>% pivot_longer(cols = c(2:ncol(dengue_df)),
                                             names_to = 'country', 
                                             values_to = 'cases') %>% na.omit()

# Gapminder data ----
## The third dataframe is the gapminder dataframe from the dslabs package
## This dataframe is already tidy
```

To make the data more relational a couple things have to be changed. The columns describing the countries and dates should be comparable across the different dataframes so they can be joined later. This was achieved with the following code.

```{r make data relational}
# Change country column ----
## All 'country' columns should be the same in type, class and values
## For flu and dengue they're characters, for gapminder it's a factor
## Turning the 'country' column of both dengue and flu into a factor
flu_df_tidy$country <- as.factor(flu_df_tidy$country)
dengue_df_tidy$country <- as.factor(dengue_df_tidy$country)

# Change date column ----
## All 'date' columns should be the same in type, class and values
## For flu and dengue the dates are specified to the day instead of the year
## We'll create a new 'year' column for both which matches the column of gapminder
flu_df_tidy <- flu_df_tidy %>% mutate(year = substr(flu_df_tidy$Date, 
                                                    start=1, stop=4))
dengue_df_tidy <- dengue_df_tidy %>% mutate(year = substr(dengue_df_tidy$Date,
                                                          start=1, stop=4))

# Make them integers ----
## Now they're characters, they should be integers
flu_df_tidy$year <- as.integer(flu_df_tidy$year)
dengue_df_tidy$year <- as.integer(dengue_df_tidy$year)
```

The dataframes were also exported to .csv and .rds for later use.

```{r export as csv and rds}
save_csv_rds(flu_df_tidy, "data/relationaldata/flu")
save_csv_rds(dengue_df_tidy, "data/relationaldata/dengue")
save_csv_rds(gapminder, "data/relationaldata/gapminder")
```

----

## Connecting to DBeaver

To move from R to SQL (PostgreSQL) a database has been created in DBeaver called 'workflowsdb'. The three R dataframes were imported into the database using RPostgreSQL. The tables were inserted into the hierarchy of this database as shown in figure 4.1.

```{r DBeaver connect, eval=FALSE}
con <- dbConnect(RPostgres::Postgres(), 
                 dbname = "workflowsdb", 
                 host="localhost", 
                 port="5432", 
                 user="postgres", 
                 password="insertpassword") 
# Password changed after connecting for privacy reasons
```

```{r data to dbeaver, eval=FALSE}
# Using the DBI library
dbWriteTable(con, "gapminder", gapminder)
dbWriteTable(con, "flu", flu_df_tidy)
dbWriteTable(con, "dengue", dengue_df_tidy)
```

![_Figure 4.1. The hierarchy of the workflowsdb database including the three tables._](images/sql_tree.png)

----

## Data inspection

The data was inspected using the SQL editor. A script was created for the inspection of the [gapminder](SQL/gapminder_inspection.sql), [flu](SQL/flu_inspection.sql) and [dengue](SQL/dengue_inspection.sql) data. R can also be used for the same inspections as shown below.

<details><summary><i>SQL script Gapminder</i></summary>

```{sql Gapminder inspection, eval=FALSE}
-- Checking the columnnames and types
select
	column_name, data_type 
from
	information_schema.columns
where
	table_schema = 'public'
	and table_name = 'gapminder';

-- Checking the timeframe in which the data has been collected
select
   distinct year
from
   gapminder
order by
	year desc;
-- from 1960 to 2016
	
-- Checking the countries with the highest and lowest average population
select
	country,
	AVG (population):: NUMERIC(11,0)
from 
	gapminder 
group by
	country
order by 
	avg desc; 
-- China has the highest with around 1,000,000,000
-- Greenland the lowest with around 51,000	
	
-- Checking the countries with the highest and lowest average life expectancy
select
	country,
	AVG (life_expectancy):: NUMERIC(6,2)
from
	gapminder
where life_expectancy is not null
group by
	country
order by 
	avg desc;
-- Iceland has the highest with 78.17
-- Central Africa Republic the lowest with 46.31

-- Checking how many countries are noted in the data
select
	count(distinct country)
from gapminder; 
-- 185 different countries
```
</details>

<details><summary><i>SQL script flu data inspection</i></summary>
```{sql flu inspection, eval=FALSE}
-- First we check the columnnames and types
select
	column_name, data_type 
from
	information_schema.columns
where 
	table_schema = 'public'
	and table_name = 'flu';

-- We check in which timeframe the data has been collected
select
   distinct year
from
   flu
order by
	year desc; 
-- from 2002 to 2015

	AVG (cases):: NUMERIC(6,1)
from
	flu
group by
	country
order by 
	avg desc;
-- South Africa had the most with 2698.8 on average
-- Sweden the least 5.5

-- We check how many countries are noted in the data and if they are spelled correctly
select
	distinct country
from flu; 
-- 29 different countries, all spelled correctly
```
</details>

<details><summary><i>SQL script dengue data inspection</i></summary>
```{sql dengue inspection, eval=FALSE}
-- First we check the columnnames and types
select
	column_name, data_type 
from
	information_schema.columns
where 
	table_schema = 'public'
	and table_name = 'dengue';

-- We check in which timeframe the data has been collected
select
   distinct year
from
   dengue
order by
	year desc;
-- from 2002 to 2015
	
-- We check which countries had the most and least dengue cases on average over this timeframe
select 
	country,
	AVG (cases):: NUMERIC(6,4)
from
	dengue
group by
	country
order by 
	avg desc;
-- Venezuela had the most with 0.2774 on average
-- Bolivia the least with 0.0447

-- We check how many countries are noted in the data and if they are spelled correctly
select
	distinct country
from dengue;
-- 10 different countries, all spelled correctly
```
</details>

<details><summary><i>R script data inspection</i></summary>
```{r inspection, eval = FALSE}
# Check the columnnames and types ----
str(gapminder_df)
str(flu_df_tidy)
str(dengue_df_tidy)

# Check the timeframes ----
paste("From", min(unique(gapminder_df$year)), "to", max(unique(gapminder_df$year)))
paste("From", min(unique(flu_df_tidy$year)), "to", max(unique(flu_df_tidy$year)))
paste("From", min(unique(dengue_df_tidy$year)), "to", max(unique(dengue_df_tidy$year)))

# Inspect gapminder ----
## Checking the highest and lowest average population in the gapminder data
options(scipen=999)
gapminder_pop <- gapminder_df %>% group_by(country) %>% summarize(average = mean(population, na.rm = TRUE))
gapminder_pop %>% filter(average == max(gapminder_pop$average) | average == min(gapminder_pop$average))

## Checking the highest and lowest average life expectancy in the gapminder data
gapminder_life <- gapminder_df %>% group_by(country) %>% summarize(average = mean(life_expectancy, na.rm = TRUE))
gapminder_life %>% filter(average == max(gapminder_life$average) | average == min(gapminder_life$average)) 

# Inspect flu ----
## Checking the most and least average flu cases in the flu data
flu_cases <- flu_df_tidy %>% group_by(country) %>% summarize(average = mean(cases, na.rm = TRUE))
flu_cases %>% filter(average == max(flu_cases$average) | average == min(flu_cases$average))

# Inspect dengue ----
## Checking the most and least average dengue cases in the dengue data
dengue_cases <- dengue_df_tidy %>% group_by(country) %>% summarize(average = mean(cases, na.rm = TRUE))
dengue_cases %>% filter(average == max(dengue_cases$average) | average == min(dengue_cases$average)) 

# Check countries ----
length(unique(gapminder_df$country)) # 185 countries
length(unique(flu_df_tidy$country)) # 29 countries
length(unique(dengue_df_tidy$country)) # 10 countries
```
</details>

----

## Joining datasets

The three datasets have two variables in common, country and year. Both the flu and dengue datasets have multiple observations within the same year. Sadly, the flu and dengue databases are very unclear. Since the data is old and the links provided in the metadata are no longer working it is hard to estimate the details of this data. Per how many inhabitants are the cases? What were the criteria to be considered a case? Other factors, like the option to get a diagnosis within that region, should also be considered. 

To combine the datasets the average amount of weekly cases per year per country was used. This was a better option than total average per year because not every country has data for every week of each year, therefore taking the sum would not be accurate. The dengue dataset incorporates the least amount of countries. When joining the data only the countries seen in all three datasets will be kept, these are Argentina, Bolivia, Brazil and Mexico. Therefore, joining the three datasets would waste a lot of data. Since dengue and flu will be looked at separately those two datasets will not be joined. Two joined tables have been made, one joining the flu and gapminder data and one joining the dengue and gapminder data.

[Click here](SQL/joining_gapminder_dengue.sql) for the full SQL script written to join the dengue and gapminder datasets based on country and year. [This SQL script](SQL/joining_gapminder_flu.sql) was used to combine the flu and gapminder datasets, this time with a focus on continents instead of countries.

The joined tables were imported into R using the following code.

```{r joined table import}
gd_country <- read_csv("data/relationaldata/gapminder_dengue_country.csv")
gf_continent <- read_csv("data/relationaldata/gapminder_flu_continent.csv")
```

----

## Descriptive statistics

With these new joined tables we can perform some descriptive statistics. The cases have not been normalized for the population so it will be normalized to reflect the amount of cases per 100.000 inhabitants instead. Then the average amount of cases and standard deviation will be determined for each country/continent. After using the shapiro-wilk test both databases appeared to have at least a few non-normally distributed variables, 5 out of 10 for the dengue database and 3 out of 5 for the flu database. The Levene's test showed that neither database had an equality of variance between countries/continents. Because of this (lack of normality <i>and</i> no equality of variance) the Kruskal-Wallis test was used to check for significant differences. Both databases brought back a p-value of .0000. The Dunn test was used as Post Hoc test to see where the statistically significant difference came from.

<details><summary><i>The script used to find descriptive statistics</i></summary>

```{r descriptive stats}
# Normalize for population ----
gd_norm_country <- gd_country %>% mutate(cases_per_100000 = 
                                           cases/population*100000)
gf_norm_continent <- gf_continent %>% mutate(cases_per_100000 = 
                                               cases/population*100000)

# Mean and stdev ----
gd_summ <- gd_norm_country %>% 
                        group_by(country)%>% 
                        summarize(avg_population = round(mean(population), 0),
                                  sd_population = round(sd(population), 0),
                                  avg_cases_per_100000 = mean(cases_per_100000),
                                  sd_cases_per_100000 = sd(cases_per_100000))

gf_summ <- gf_norm_continent %>% 
                        group_by(continent)%>% 
                        summarize(avg_population = round(mean(population), 0),
                                  sd_population = round(sd(population), 0),
                                  avg_cases_per_100000 = mean(cases_per_100000),
                                  sd_cases_per_100000 = sd(cases_per_100000))

# Check normality ----
## To check the normality, dataframes are made with the countries/continents as columns
dengue_country <- gd_norm_country %>% 
                        select(country, cases_per_100000, year) %>% 
                        pivot_wider(names_from = country, 
                                    values_from = cases_per_100000) %>% 
                        filter(year != 2002)

flu_continent <- gf_norm_continent %>% 
                        select(continent, cases_per_100000, year) %>% 
                        pivot_wider(names_from = continent, 
                                    values_from = cases_per_100000) %>% 
                        filter(year != 2002)

## Shapiro wilk for dengue
stats_dengue_country <- data.frame(country = colnames(dengue_country[,2:length(colnames(dengue_country))]),
                                     pvalue_shap = round(c(shapiro.test(dengue_country$Venezuela)$p.value,
                                                shapiro.test(dengue_country$Thailand)$p.value,
                                                shapiro.test(dengue_country$Singapore)$p.value,
                                                shapiro.test(dengue_country$Philippines)$p.value,
                                                shapiro.test(dengue_country$Mexico)$p.value,
                                                shapiro.test(dengue_country$Indonesia)$p.value,
                                                shapiro.test(dengue_country$India)$p.value,
                                                shapiro.test(dengue_country$Brazil)$p.value,
                                                shapiro.test(dengue_country$Bolivia)$p.value,
                                                shapiro.test(dengue_country$Argentina)$p.value), 4))

## Shapiro wilk for flu
stats_flu_continent <- data.frame(continent = colnames(flu_continent[,2:length(colnames(flu_continent))]),
                                     pvalue_shap = round(c(shapiro.test(flu_continent$Oceania)$p.value,
                                                shapiro.test(flu_continent$Europe)$p.value,
                                                shapiro.test(flu_continent$Asia)$p.value,
                                                shapiro.test(flu_continent$Americas)$p.value,
                                                shapiro.test(flu_continent$Africa)$p.value), 4))

## Normality results
stats_dengue_country <- stats_dengue_country %>% mutate(normal_dis = pvalue_shap>0.05) 
## 5 out of 10 are normally distributed
stats_flu_continent <- stats_flu_continent %>% mutate(normal_dis = pvalue_shap>0.05) 
## 3 out of 5 are normally distributed

# Levene test ----
leveneTest(cases_per_100000 ~ country, data = gd_norm_country)[1,3] # P-value of .0000
leveneTest(cases_per_100000 ~ continent, data = gf_norm_continent)[1,3] # P-value of .0015
## The variances are not equal

# Kruskal Wallis test ----
kruskal.test(cases_per_100000 ~ country, data = gd_norm_country) 
## P-value of .0000, there is statistically significant difference
kruskal.test(cases_per_100000 ~ continent, data = gf_norm_continent)
## P-value of .0000, there is statistically significant difference

# Post-Hoc Dunn test ----
dunn_dengue_country <- dunnTest(cases_per_100000 ~ country, 
                                data = gd_norm_country, method = "holm")$res
dunn_flu_continent <- dunnTest(cases_per_100000 ~ continent, 
                               data = gf_norm_continent, method = "holm")$res

# Significant differences ----
dunn_dengue_country <- dunn_dengue_country %>% mutate(different = P.adj<0.05)
dunn_flu_continent <- dunn_flu_continent %>% mutate(different = P.adj<0.05)
```
</details>

```{r outcome stats}
# Note the significant differences between countries/continents
diff_dengue_country <- dunn_dengue_country %>% filter(different == TRUE)
diff_flu_continent <- dunn_flu_continent %>% filter(different == TRUE)
# Note the comparable countries/continents
nondiff_dengue_country <- dunn_dengue_country %>% filter(different == FALSE)
nondiff_flu_continent <- dunn_flu_continent %>% filter(different == FALSE)
```

Seperate tables were made to show the combinations <i>with</i> significant difference and <i>without</i>. For the dengue data, 26 out of 45 combinations between the 10 countries were not significantly different in amount of dengue cases per week per 100.000 inhabitants. For the flu data, 3 out of 10 combinations between the 5 continents were not significantly different in amount of flu cases per week per 100.000 inhabitants.

----

## Visualizations

We can also create varying visualizations to get an overall look of how the countries/continents compare to each other and how the numbers changed through the years.

### Dengue cases

In figure 4.2 a scatterplot shows the average amount of weekly dengue cases per year with a different color for each country. Singapore has a clear higher number of cases for each year, except 2009. Singapore's climate is a natural breeding ground for the dengue-carrying Aedes mosquitoes, which prefer a tropical climate according to @khetarpalDengueFeverCauses2016. By the end of 2016 27% of outbreak-associated dengue cases reported in literature had been in Singapore, second to China with 27.9% [@guoGlobalEpidemiologyDengue2017].  

```{r dengue visualization}
# Dengue scatterplot ----
## Visualising the weekly dengue cases per country per year in a scatterplot
ggplot(gd_norm_country, aes(x=year, y=cases_per_100000, 
                            group = country, color = country)) + 
  geom_point() +
  geom_line() +
  labs(title = "Dengue cases",
       y = "Average dengue cases per week",
       x = "Year") +
  scale_x_continuous(breaks = round(seq(min(gd_norm_country$year), 
                                        max(gd_norm_country$year), 
                                        by = 1),1)) +
  theme_minimal()
```

_Figure 4.2. Scatterplot to show the average amount of weekly dengue cases per 100.000 inhabitants per year per country._

### Flu cases

For the flu cases we will be comparing continents instead of countries, first comparing the average amount of weekly flu cases per 100.000 inhabitants per continent per year. In figure 4.3 a bar graph shows the average per continent with the standard deviation as error bars. Africa has a clear higher average of 5.2 per 100.000 inhabitants per week. In less tropical continents, like Europe and North America, most flu cases occur in the colder months. In more tropical continents, like Africa, they occur all throughout the year [@yazdanbakhshInfluenzaAfrica2009]. Multiple factors like, access to health care, poor nutrition, chronic infections and indoor air pollution could contribute to the increase in flu cases [@ortizPandemicInfluenzaAfrica2012].

```{r flu bar visualization}
# Flu bargraph ----
## Make a bar graph with the relative average population and weekly flu cases
ggplot(gf_summ, aes(x=reorder(continent, -avg_cases_per_100000), 
                             y=avg_cases_per_100000, fill=continent)) +
  geom_bar(stat="identity", position=position_dodge(), show.legend = FALSE) +
  geom_errorbar(aes(ymin=avg_cases_per_100000-sd_cases_per_100000, ymax=avg_cases_per_100000+sd_cases_per_100000), width=.2) +
  labs(title = "Flu cases per continent",
       y = "Flu cases per week per 100.000 inhabitants",
       x = NULL) +
    theme_minimal()
```

_Figure 4.3. The average amount of weekly flu cases per 100.000 inhabitants per continent from approx. 2003 to 2015._

For further analysis a scatterplot has been made, shown in figure 4.4. One points which stands out for all continents except Oceania is the increase in 2009, only to go back down again in 2010. In 2009 there was a pandemic called the Swine Flu which might be the cause of this sudden jump in flu cases for all continents [@akinUnderstandingDynamicsPandemics2020]. This also explains why Oceania was affected less, as it is separated from other continents by oceans.

```{r flu scatter visualization}
# Flu scatterplot ----
## Visualising the weekly dengue cases per continent per year in a scatterplot
ggplot(gf_norm_continent, aes(x=year, y=cases_per_100000, 
                              group = continent, color = continent)) + 
  geom_point() +
  geom_line() +
  labs(title = "Weekly flu cases across the world",
       y = "Weekly flu cases",
       x = "Year") +
  scale_x_continuous(breaks = round(seq(min(gf_norm_continent$year), 
                                        max(gf_norm_continent$year), by = 1),1)) +
  theme_minimal()
```

_Figure 4.4. Scatterplot to show the average amount of weekly flu cases per year per continent._