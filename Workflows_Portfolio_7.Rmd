# Relational data

_As part of assignment 7 from the [DSFB2 Workflows course](https://lesmaterialen.rstudio.hu.nl/workflows-reader/#course-introduction)._

----

So far I have been working with R, BASH, HTML and CSS. Another important language to understand is SQL. With this assignment I'll focus on learning the basics of SQL and applying it to relational data. We will start by creating three dataframes and making them tidy.

```{r import and tidy}
# Importing the flu dataframe
flu_df <- read_csv("data-raw/data070/flu_data.csv", skip=11) ## First 11 rows are metadata
# Making the flu dataframe tidy
flu_df_tidy <- flu_df %>% pivot_longer(cols = c(2:ncol(flu_df)), names_to = 'country', values_to = 'cases') %>% na.omit()

# Importing the dengue dataframe
dengue_df <- read_csv("data-raw/data070/dengue_data.csv", skip=11) ## First 11 rows are metadata

# Making the dengue dataframe tidy
dengue_df_tidy <- dengue_df %>% pivot_longer(cols = c(2:ncol(dengue_df)), names_to = 'country', values_to = 'cases') %>% na.omit()

# The third dataframe is the gapminder dataframe from the dslabs package
# This dataframe is already tidy
```

To make the data more relational a couple things have to be changed. The columns describing the countries and dates should be comparable across the different dataframes. This was achieved with the following code.

```{r country and date}
# All 'country' columns should be the same in type, class and values
# For flu and dengue they're characters, for gapminder it's a factor
# Turning the 'country' column of both dengue and flu into a factor
flu_df_tidy$country <- as.factor(flu_df_tidy$country)
dengue_df_tidy$country <- as.factor(dengue_df_tidy$country)

# All 'date' columns should be the same in type, class and values
# For flu and dengue the dates are specified to the day instead of the year
# We'll create a new 'year' column for both which matches the column of gapminder
flu_df_tidy <- flu_df_tidy %>% mutate(year = substr(flu_df_tidy$Date, start=1, stop=4))
dengue_df_tidy <- dengue_df_tidy %>% mutate(year = substr(dengue_df_tidy$Date, start=1, stop=4))
# Now they're characters, they should be integers
flu_df_tidy$year <- as.integer(flu_df_tidy$year)
dengue_df_tidy$year <- as.integer(dengue_df_tidy$year)
```

To use the dataframes in DBeaver they should be exported to .csv and .rds. 

```{r export}
# Export the three dataframes as csv
write.csv(flu_df_tidy, "data/data070/flu.csv", row.names=FALSE)
write.csv(dengue_df_tidy, "data/data070/dengue.csv", row.names=FALSE)
write.csv(gapminder, "data/data070/gapminder.csv", row.names=FALSE)

# Export the three dataframes as rds
saveRDS(flu_df_tidy, file="data/data070/flu.rds")
saveRDS(dengue_df_tidy, file="data/data070/dengue.rds")
saveRDS(gapminder, file="data/data070/gapminder.rds")
```



In Dbeaver create a new PostgreSQL database “workflowsdb”

Using RPostgreSQL, insert the tables into the database.

Inspect the contents of the tables with SQL (in DBeaver) and save the SQL script.

Inspect the contents of the tables with dplyr (in R) and save a RMarkdown showing what you are doing.

Load the gapminder data in R and change the dataframe in such as way that you could join it to dengue and flue.

Save this clean gapminder data in the “workflowsdb” database

Perform some joins (your choice) with SQL (can be done in DBeaver or with dplyr.

Generate a joined table, and export this from the database to R.

Show some descriptive statistics with this table, and at least 3 visualisations using ggplot2.

Write a short report to show at least te actions listed in this assignment in a Rmd file for your portfolio. Include pictures and provide text explaining and showcasing your skills.